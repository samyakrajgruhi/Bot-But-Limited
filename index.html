<!DOCTYPE html>
<html>
	<head>
		<title>Chat Bot</title>
		<link rel="stylesheet" href="/chatbot.css">
	</head>
	<body>
		<div>
			<div class="js-container"></div>
		</div>

		<script src="https://unpkg.com/supersimpledev/react.js"></script>
		<script src="https://unpkg.com/supersimpledev/react-dom.js"></script>
		<script src="https://unpkg.com/supersimpledev/chatbot.js"></script>

		<script src="https://unpkg.com/supersimpledev/babel.js"></script>
		<script type="text/babel">

		function ChatMessage({message,sender,id}){
			// const message = props.message;
			// const sender = props.sender;
			// const {message,sender} = props;
			return (
				<div className={sender === 'robot' ? 'robot-message' : 'user-message'}>
					{sender === 'robot' && (
						<img src="images/robot.png" className="chat-message-user-icon" />
					)} 
					<div className='chat-message'>
						{message}
					</div>
					{sender === 'user' && (
						<img src="images/user.png" className="chat-message-user-icon" />
					)}
				</div>
			);
		}

		function ChatInput({chatMessages,setChatMessages}){
			const [inputText, setInputText] = React.useState('');
			const [isLoading,setIsLoading] = React.useState(false);

			function saveToText(event){
				setInputText(event.target.value);
			}

			async function sendMessage(){
				if(isLoading || inputText === ''){
					return
				}
				setIsLoading(true);
				setInputText('');
				const newChatMessages = [
					...chatMessages,{
						message: inputText,
						sender: 'user',
						id: crypto.randomUUID()
					}
				];
				setChatMessages(newChatMessages);

				// This is to display "Loading..." while the bot is thinking what to respons...
				setChatMessages([
					...newChatMessages,{
						message: 'Loading...',
						sender:'robot',
						id: crypto.randomUUID()
					}
				]);

				const botResponse = await Chatbot.getResponseAsync(inputText);
				setChatMessages([
					...newChatMessages,{
						message: botResponse,
						sender:'robot',
						id: crypto.randomUUID()
					}
				]);	
				setIsLoading(false);			
			}

			function sendWithEnter(event){
				if(event.key === 'Enter'){
					sendMessage();
				}else if(event.key === 'Escape'){
					setInputText('');
				}
			}

			return (
				<div className="input-container">
					<input 
						disabled={isLoading}
						placeholder="Send a message to Chatbot" 
						onChange={saveToText}
						onKeyDown={sendWithEnter}
						value={inputText}
						className="message-input"
					/>
					<button
					onClick={sendMessage}
					className="send-button"
					>Send</button>
				</div>
			);
		}

		function ChatMessages({chatMessages}){

			const chatMessagesRef = React.useRef(null);

			React.useEffect(()=>{
				const containerElem = chatMessagesRef.current;
				if(containerElem){
					containerElem.scrollTop = containerElem.scrollHeight;
				}
			},[chatMessages]);
			return (				
				<>
					<div 
						className="messages-section"
						ref={chatMessagesRef}
					>
						{chatMessages.map((chatMessage)=>{
							return (
								<ChatMessage 
									message={chatMessage.message}
									sender={chatMessage.sender}
									key={chatMessage.id}
								/>
							);	
						})}
					</div>
				</>
			);
		}

		function App(){
			const [chatMessages, setChatMessages] = React.useState([{
				message:'Hello chatbot',
				sender:'user',
				id:'id1'
			},{
				message:'Hello! How can I help you?',
				sender:'robot',
				id:'id2'
			},{
				message:'can you get me todays date?',
				sender:'user',
				id:'id3'
			},{
				message:'Today is January 27',
				sender:'robot',
				id:'id4'
			}]);
			// const [chatMessages, setChatMessages] = array;
			// const chatMessages = array[0];
			// const setChatMessages = array[1];	
			return (
			<div className="app-container">
				<ChatMessages 
					chatMessages={chatMessages}
				/>
				<ChatInput 
					chatMessages={chatMessages}
					setChatMessages={setChatMessages}
				/>
			</div>
			);
		}

		const container = document.querySelector('.js-container');
		ReactDOM.createRoot(container).render(<App />);
		</script>
	</body>
</html>